<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jessie Math - æ€æ¨£è§£é¡Œ(äºŒ)</title>

    <!-- âœ… å¿«å–é€£çµé è¦½ï¼ˆè«‹æ”¾åœ¨ <head> è£¡ï¼‰ -->
    <meta name="description" content="Â© 2025â€“2026 Jessie Math æ·æè€å¸«. All rights reserved.">
    <!-- âœ… LINE / FB é è¦½ç”¨ -->
    <meta property="og:title" content="Jessie Math  - æ€æ¨£è§£é¡Œ(äºŒ)">
    <meta property="og:description" content="Â© 2025â€“2026 Jessie Math æ·æè€å¸«. All rights reserved.">
    <meta property="og:type" content="website">

    <!-- âœ… é è¦½åœ–ç‰‡-->
    <meta property="og:image" content="g6-u14.png">
    <meta property="og:image:width" content="1024">
    <meta property="og:image:height" content="1536">
    <meta property="og:image:alt" content="Jessie Math éŠæˆ²å°é¢">

    <!-- âœ… æœ‰äº›å¹³å°æœƒåƒè€ƒ -->
    <link rel="image_src" href="g6-u14.png">

    <!-- âœ… Twitter / Xï¼ˆå¯ç”¨åŒä¸€å¼µåœ–ï¼‰ -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Jessie Math  - æ€æ¨£è§£é¡Œ(äºŒ)">
    <meta name="twitter:description" content="Â© 2025â€“2026 Jessie Math æ·æè€å¸«. All rights reserved.">
    <meta name="twitter:image" content="g6-u14.png">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-yellow: #FFD700;
            --brand-blue: #2C3E50;
            --accent-purple: #706fd3;
            --btn-pause: #ff9f43;
            --btn-redo: #54a0ff;
            --btn-menu: #576574;

            --bg-glass: rgba(255,255,255,0.92);
            --line: rgba(0,0,0,0.08);
        }

        *{ box-sizing: border-box; }

        body {
            margin: 0;
            font-family: "Microsoft JhengHei", sans-serif;
            background-color: #f9f9f9;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Hero Area */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            gap: 12px;
            flex-wrap: wrap;
        }

        .brand-zone { display: flex; align-items: center; }

        .logo-circle {
            width: 50px; height: 50px;
            background: var(--primary-yellow);
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            margin-right: 15px;
            flex: 0 0 auto;
        }

        .logo-circle img { width: 90%; background: transparent; }

        .brand-name { font-size: 24px; font-weight: bold; color: var(--brand-blue); }

        .nav-buttons { display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; }

        .nav-btn {
            text-decoration: none; padding: 8px 15px; border-radius: 20px;
            border: 1px solid #ddd; color: #333; font-size: 14px;
            display: flex; align-items: center; gap: 5px; transition: 0.3s;
            white-space: nowrap;
        }

        .btn-purple { border-color: var(--accent-purple); color: var(--accent-purple); }

        /* Screens */
        .screen {
            display: none;
            width: min(850px, calc(100% - 24px));
            margin: 24px auto;
            padding: 26px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }
        .active { display: block; }

        .btn-main {
            background: var(--brand-blue); color: white;
            padding: 12px 30px; border: none; border-radius: 25px;
            font-size: 18px; cursor: pointer; margin: 10px; transition: 0.2s;
            width: auto;
            max-width: 100%;
        }
        .btn-main:hover { transform: scale(1.05); }

        /* æ¨¡å¼é¸æ“‡æŒ‰éˆ• */
        .mode-container { display: flex; justify-content: center; gap: 10px; margin: 15px 0; flex-wrap: wrap; }
        .mode-btn {
            padding: 10px 20px; border-radius: 15px; border: 2px solid #ddd;
            background: white; cursor: pointer; font-weight: bold; transition: 0.3s;
        }
        .mode-btn.selected { border-color: var(--brand-blue); background: #eef5ff; color: var(--brand-blue); }

        /* æ’è¡Œæ¦œ */
        .leaderboard-container { margin-top: 30px; background: #fcfcfc; border-radius: 15px; padding: 15px; border: 1px dashed #ccc; overflow-x: auto; }
        #leaderboard { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; min-width: 520px; }
        #leaderboard th, #leaderboard td { padding: 10px; border-bottom: 1px solid #eee; }

        /* éŠæˆ²æŒ‰éˆ•æ§åˆ¶ */
        .game-controls { display: flex; justify-content: center; gap: 15px; margin-top: 30px; flex-wrap: wrap; }
        .control-btn {
            flex: 1; max-width: 150px; min-width: 140px;
            padding: 12px 0; border-radius: 50px;
            border: none; color: white; font-weight: bold; font-size: 16px;
            cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: 0.3s;
        }
        .btn-p { background-color: var(--btn-pause); }
        .btn-r { background-color: var(--btn-redo); }
        .btn-m { background-color: var(--btn-menu); }
        .control-btn:hover { transform: translateY(-3px); filter: brightness(1.1); }

        .stats-bar {
            display: flex; justify-content: space-around;
            background: #f0f3f6;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 14px; /* âœ… ç•™å‡ºå›é¥‹å€ */
            border: 2px solid #e0e0e0;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* âœ… ä½œç­”å€å›é¥‹ï¼ˆé¡¯ç¤ºåœ¨é¡Œç›®/é¸é …ä¸Šæ–¹ï¼Œä¸ç”¨ alertï¼‰ */
        .feedback-bar{
            margin: 0 0 14px;
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid var(--line);
            background: rgba(255,255,255,0.9);
            box-shadow: 0 8px 20px rgba(0,0,0,0.06);
            display: none;
            text-align: left;
            line-height: 1.5;
            font-size: 15px;
        }
        .feedback-bar.show{ display:block; }
        .feedback-ok{
            border-color: rgba(39,174,96,0.35);
            background: rgba(39,174,96,0.08);
        }
        .feedback-bad{
            border-color: rgba(231,76,60,0.35);
            background: rgba(231,76,60,0.08);
        }
        .feedback-title{
            font-weight: 800;
            margin-bottom: 4px;
            display:flex;
            align-items:center;
            gap:8px;
        }
        .feedback-detail{
            color: #334155;
            font-size: 14px;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        .option-btn {
            padding: 15px;
            font-size: 18px;
            border: 2px solid #ddd;
            border-radius: 12px;
            cursor: pointer;
            background: white;
            width: 100%;
        }
        .option-btn:hover { background: #eef5ff; }

        /* âœ… Footer */
        footer{
            margin-top: auto;
            padding: 18px 12px 24px;
        }
        .footer-pill{
            width: min(980px, calc(100% - 24px));
            margin: 0 auto;
            background: var(--bg-glass);
            border: 1px solid var(--line);
            border-radius: 999px;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            box-shadow: 0 10px 28px rgba(0,0,0,0.08);
            backdrop-filter: blur(10px);
        }
        .footer-left, .footer-right{
            display:flex;
            align-items:center;
            gap:10px;
            min-width: 0;
        }
        .footer-dot{
            width:10px; height:10px;
            border-radius:50%;
            background: var(--primary-yellow);
            box-shadow: 0 0 0 4px rgba(255,215,0,0.18);
            flex: 0 0 auto;
        }
        .footer-copy{
            font-size: 13px;
            color: #334155;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .footer-icon{
            width:28px; height:28px;
            border-radius: 10px;
            display:flex; align-items:center; justify-content:center;
            background: rgba(44,62,80,0.08);
            color: var(--brand-blue);
            flex: 0 0 auto;
        }
        .footer-tagline{
            font-size: 13px;
            color: #334155;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* âœ… RWD Breakpoints */
        @media (max-width: 900px){
            .screen{ padding: 22px; }
            .brand-name{ font-size: 22px; }
            #leaderboard{ min-width: 480px; }
        }

        @media (max-width: 640px){
            header{ padding: 10px 12px; }
            .brand-name{ font-size: 20px; }
            .nav-btn{ padding: 8px 12px; font-size: 13px; }
            .options-grid{ grid-template-columns: 1fr; }
            .control-btn{ max-width: none; min-width: 160px; }
            .footer-pill{
                border-radius: 18px;
                flex-direction: column;
                align-items: flex-start;
            }
            .footer-copy, .footer-tagline{ width: 100%; }
        }

        @media (max-width: 380px){
            .logo-circle{ width: 44px; height: 44px; margin-right: 10px; }
            .btn-main{ font-size: 16px; padding: 11px 18px; }
            .option-btn{ font-size: 16px; }
        }
    </style>
</head>
<body>

<header>
    <div class="brand-zone">
        <div class="logo-circle"><img src="JESSIEMATH-Q.png" alt="Jessie Math"></div>
        <div class="brand-name">Jessie Math</div>
    </div>
    <div class="nav-buttons">
        <a href="https://jessiemath0703-chu.github.io/website2/" class="nav-btn"><i class="fas fa-home"></i> é¦–é </a>
        <a href="https://jessiemath0703-chu.github.io/Game-Lobby/" class="nav-btn"><i class="fas fa-gamepad"></i> éŠæˆ²å¤§å»³</a>
        <a href="https://jessiemath0703-chu.github.io/Game-Lobby/#g6-u14" class="nav-btn btn-purple"><i class="fas fa-undo"></i> å…­å¹´ç´šæ€æ¨£è§£é¡Œ(äºŒ)</a>
    </div>
</header>

<div id="start-screen" class="screen active">
    <h2>å…­å¹´ç´š æ€æ¨£è§£é¡Œ(äºŒ)</h2>
    <input type="text" id="player-name" placeholder="è«‹è¼¸å…¥ä½ çš„åå­—" style="padding: 12px; width: min(280px, 100%); font-size: 16px; border-radius: 10px; border: 1px solid #ccc; margin-bottom: 20px;">
    <div class="rules" style="text-align: left; background: #fffbe6; padding: 20px; border-radius: 15px; border-left: 5px solid var(--primary-yellow);">
        <p><strong>ğŸŒŸ éŠæˆ²è¦å‰‡ï¼š</strong></p>
        <ul style="line-height: 1.6;">
            <li>âœ… <strong>ç­”å°ï¼š</strong> æ™‚é–“åŠ  5 ç§’ï¼Œç´¯ç© Combo åˆ†æ•¸æ›´é«˜ã€‚</li>
            <li>âŒ <strong>ç­”éŒ¯ï¼š</strong> æ™‚é–“æ‰£ 5 ç§’ï¼ŒCombo ä¸­æ–·ã€‚</li>
            <li>ğŸ† <strong>ç´€éŒ„ï¼š</strong> æ’è¡Œæ¦œå°‡è¨˜éŒ„æ‚¨çš„å§“åã€é—œå¡èˆ‡æŒ‘æˆ°æ¨¡å¼ã€‚</li>
        </ul>
    </div>
    <button class="btn-main" onclick="goToMenu()">é€²å…¥æŒ‘æˆ°</button>
</div>

<div id="menu-screen" class="screen">
    <h2>é¸æ“‡é—œå¡èˆ‡æ¨¡å¼</h2>
    <div id="welcome-msg" style="margin-bottom: 15px; font-weight: bold;"></div>

    <div style="background: #fdfdfd; padding: 15px; border-radius: 10px; border: 1px solid #eee;">
        <p style="margin-top: 0; font-weight: bold; color: #e67e22;">ç¬¬ä¸€æ­¥ï¼šé¸æ“‡æŒ‘æˆ°é›£åº¦</p>
        <div class="mode-container">
            <button class="mode-btn selected" id="mode-easy" onclick="selectMode('åŸºç¤', 120)">åŸºç¤ (120s)</button>
            <button class="mode-btn" id="mode-normal" onclick="selectMode('é€²éš', 90)">é€²éš (90s)</button>
            <button class="mode-btn" id="mode-hard" onclick="selectMode('é­”ç‹', 60)">é­”ç‹ (60s)</button>
        </div>
    </div>

    <p style="margin-top: 20px; font-weight: bold; color: #2980b9;">ç¬¬äºŒæ­¥ï¼šé¸æ“‡é¡Œç›®é—œå¡</p>
    <div style="display: flex; flex-direction: column; align-items: center; gap: 10px;">
        <button class="btn-main" style="width: min(80%, 520px); background: #ff7f50;" onclick="startGame('rate', 'ç¬¬ä¸€é—œï¼šé€Ÿç‡å•é¡Œ')">ç¬¬ä¸€é—œï¼šé€Ÿç‡å•é¡Œ</button>
        <button class="btn-main" style="width: min(80%, 520px); background: #6a89cc;" onclick="startGame('age', 'ç¬¬äºŒé—œï¼šå¹´é½¡å•é¡Œ')">ç¬¬äºŒé—œï¼šå¹´é½¡å•é¡Œ</button>
        <button class="btn-main" style="width: min(80%, 520px); background: #78e08f;" onclick="startGame('avg', 'ç¬¬ä¸‰é—œï¼šå¹³å‡å•é¡Œ')">ç¬¬ä¸‰é—œï¼šå¹³å‡å•é¡Œ</button>
    </div>

    <div class="leaderboard-container">
        <h3>ğŸ† å‰ååæ¦®è­½æ¦œ</h3>
        <table id="leaderboard"></table>
    </div>
</div>

<div id="game-screen" class="screen">
    <div class="stats-bar">
        <div>â³ <span id="timer">60</span>s</div>
        <div>â­ <span id="score">0</span> åˆ†</div>
        <div style="color: #ff4757; font-weight: bold;" id="combo-text">Combo x0</div>
    </div>

    <!-- âœ… å›é¥‹ç›´æ¥é¡¯ç¤ºåœ¨ä½œç­”å€ï¼ˆé¡Œç›®/é¸é …ä¸Šæ–¹ï¼‰ -->
    <div id="feedback" class="feedback-bar" aria-live="polite"></div>

    <div id="question-area">
        <h3 id="question-text" style="min-height: 50px;">é¡Œç›®è¼‰å…¥ä¸­...</h3>
        <div class="options-grid" id="options"></div>
    </div>
    <div class="game-controls">
        <button class="control-btn btn-p" onclick="pauseGame()"><i class="fas fa-pause"></i> æš«åœ</button>
        <button class="control-btn btn-r" onclick="restartLevel()"><i class="fas fa-redo"></i> é‡æ–°</button>
        <button class="control-btn btn-m" onclick="exitToMenu()"><i class="fas fa-list"></i> é¸å–®</button>
    </div>
</div>

<footer>
    <div class="footer-pill">
        <div class="footer-left">
            <div class="footer-dot" aria-hidden="true"></div>
            <div class="footer-copy">Â© 2025â€“2026 Jessie Math æ·æè€å¸«. All rights reserved.</div>
        </div>
        <div class="footer-right">
            <div class="footer-icon" aria-hidden="true"><i class="fas fa-compass"></i></div>
            <div class="footer-tagline">æ•¸å­¸ä¸è¿·è·¯ï¼ŒJessie å¸¶ä½ èµ°å‘ç†è§£ã€‚</div>
        </div>
    </div>
</footer>

<script>
    let playerName = "";
    let score = 0;
    let timeLeft = 60;
    let baseTime = 120;
    let currentModeName = "åŸºç¤";
    let combo = 0;
    let timerId;
    let currentCategory = "";
    let currentLevelName = "";

    let roundDeck = [];
    let roundIndex = 0;
    let currentQuestion = null;

    // âœ… å›é¥‹é¡¯ç¤ºæ§åˆ¶
    let feedbackTimer = null;
    const FEEDBACK_MS = 950; // é¡¯ç¤ºå¤šä¹…å¾Œè‡ªå‹•é€²ä¸‹ä¸€é¡Œ

    function showFeedback(type, title, detail){
        const box = document.getElementById('feedback');
        box.className = "feedback-bar show " + (type === "ok" ? "feedback-ok" : "feedback-bad");
        box.innerHTML = `
            <div class="feedback-title">${type === "ok" ? "âœ…" : "âŒ"} ${title}</div>
            <div class="feedback-detail">${detail}</div>
        `;
    }

    function clearFeedback(){
        const box = document.getElementById('feedback');
        box.className = "feedback-bar";
        box.innerHTML = "";
    }

    function lockOptions(lock){
        document.querySelectorAll('.option-btn').forEach(b => b.disabled = !!lock);
    }

    function randInt(min, max){
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function shuffle(arr){
        const a = arr.slice();
        for(let i=a.length-1;i>0;i--){
            const j = Math.floor(Math.random() * (i+1));
            [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
    }
    function uniqueOptions(correct, makeWrongFn, count=4){
        const set = new Set([correct]);
        let guard = 0;
        while(set.size < count && guard < 200){
            set.add(makeWrongFn());
            guard++;
        }
        return shuffle(Array.from(set));
    }
    function buildMCQ(q, correct, wrongGen){
        const opts = uniqueOptions(correct, wrongGen, 4);
        return { q, a: opts, c: opts.indexOf(correct) };
    }

    const baseQuestions = {
        rate: [
            { q:"å°å¯èˆ‡å°æ¨‚èµ°è·¯é€Ÿç‡åˆ†åˆ¥ç‚º 48 å…¬å°º/åˆ†èˆ‡ 60 å…¬å°º/åˆ†ï¼ŒåŒå‘åŒåœ°å‡ºç™¼ï¼Œ30 åˆ†é˜å¾Œç›¸è·å¹¾å…¬å°ºï¼Ÿ", a:["360 å…¬å°º","120 å…¬å°º","180 å…¬å°º","240 å…¬å°º"], c:0 },
            { q:"ç”²ä¹™å…©åœ°ç›¸è· 1296 å…¬å°ºï¼Œå°å¯ 48 å…¬å°º/åˆ†ï¼Œå°æ¨‚ 60 å…¬å°º/åˆ†ï¼Œç›¸å‘è€Œè¡Œï¼Œå¹¾åˆ†é˜å¾Œç›¸é‡ï¼Ÿ", a:["10 åˆ†é˜","12 åˆ†é˜","15 åˆ†é˜","18 åˆ†é˜"], c:1 },
            { q:"å¹³é¢é›»æ‰¶æ¢¯é€Ÿç‡ 0.5 å…¬å°º/ç§’ï¼Œæª¢ä¿®å“¡ç«™è‘—ä¸å‹•ï¼Œ10 ç§’å¾Œå‰é€²å¹¾å…¬å°ºï¼Ÿ", a:["5 å…¬å°º","7 å…¬å°º","10 å…¬å°º","12 å…¬å°º"], c:0 },
            { q:"è‡ºç£é›»æ‰¶æ¢¯é€Ÿç‡ 30 å…¬å°º/åˆ†ï¼Œé¦™æ¸¯æœ€å¿«é›»æ‰¶æ¢¯é€Ÿç‡ 45 å…¬å°º/åˆ†ã€‚åŒæ¨£æ­ 36 ç§’ï¼Œå…©è€…å‰é€²è·é›¢å·®å¹¾å…¬å°ºï¼Ÿ", a:["6 å…¬å°º","7.5 å…¬å°º","9 å…¬å°º","12 å…¬å°º"], c:1 }
        ],
        age: [
            { q:"çˆºçˆº 64 æ­²ï¼Œå°å¥‡ 14 æ­²ã€‚å¹¾å¹´å‰çˆºçˆºå¹´é½¡æ˜¯å°å¥‡çš„ 6 å€ï¼Ÿ", a:["4 å¹´å‰","2 å¹´å‰","6 å¹´å‰","10 å¹´å‰"], c:0 },
            { q:"çˆ¸çˆ¸ 42 æ­²ï¼Œå°å¥‡ 14 æ­²ã€‚ç•¶çˆ¸çˆ¸å¹´é½¡æ˜¯å°å¥‡ 5 å€æ™‚ï¼Œå°å¥‡å¹¾æ­²ï¼Ÿ", a:["7 æ­²","8 æ­²","9 æ­²","10 æ­²"], c:0 },
            { q:"å§å§èˆ‡å¦¹å¦¹å·® 3 æ­²ï¼Œå…©äººå¹´é½¡å’Œ 25 æ­²ï¼Œå§å§ä»Šå¹´å¹¾æ­²ï¼Ÿ", a:["11 æ­²","14 æ­²","12 æ­²","15 æ­²"], c:1 }
        ],
        avg: [
            { q:"å‰ 4 æ¬¡å°è€ƒå¹³å‡ 88 åˆ†ï¼Œç¬¬ 5 æ¬¡è¦è€ƒå¹¾åˆ†ï¼Œäº”æ¬¡å¹³å‡æ‰æœƒæ˜¯ 90 åˆ†ï¼Ÿ", a:["92 åˆ†","95 åˆ†","98 åˆ†","100 åˆ†"], c:2 },
            { q:"å°å‰èŠ± 220 å…ƒï¼Œå°åˆ©èŠ± 190 å…ƒï¼Œä¸‰äººå¹³å‡ 180 å…ƒï¼Œå°é †èŠ±å¹¾å…ƒï¼Ÿ", a:["130 å…ƒ","150 å…ƒ","180 å…ƒ","200 å…ƒ"], c:0 },
            { q:"é€±ä¸€ 320 äººã€é€±äºŒ 270 äººï¼ŒåŠ ä¸Šé€±ä¸‰å¾Œä¸‰å¤©å¹³å‡ 310 äººï¼Œé€±ä¸‰å¹¾äººï¼Ÿ", a:["340 äºº","310 äºº","300 äºº","350 äºº"], c:0 }
        ]
    };

    function generateRateQuestions(n=18){
        const list = [];
        for(let i=0;i<Math.ceil(n/4);i++){
            const v1 = randInt(30, 70), v2 = randInt(30, 70);
            if(v1 === v2) continue;
            const t = randInt(5, 40);
            const d = Math.abs(v1 - v2) * t;
            const q = `å…©äººåŒåœ°åŒå‘å‡ºç™¼ï¼Œé€Ÿç‡åˆ†åˆ¥ç‚º ${v1} å…¬å°º/åˆ†èˆ‡ ${v2} å…¬å°º/åˆ†ï¼Œ${t} åˆ†é˜å¾Œç›¸è·å¹¾å…¬å°ºï¼Ÿ`;
            list.push(buildMCQ(q, `${d} å…¬å°º`, () => `${d + randInt(-6, 8) * 10} å…¬å°º`));
        }
        for(let i=0;i<Math.ceil(n/4);i++){
            const v1 = randInt(30, 80), v2 = randInt(20, 80);
            const t = randInt(4, 20);
            const d = (v1 + v2) * t;
            const q = `å…©äººåŒåœ°åå‘åŒæ™‚å‡ºç™¼ï¼Œé€Ÿç‡åˆ†åˆ¥ç‚º ${v1} å…¬å°º/åˆ†èˆ‡ ${v2} å…¬å°º/åˆ†ï¼Œ${t} åˆ†é˜å¾Œç›¸è·å¹¾å…¬å°ºï¼Ÿ`;
            list.push(buildMCQ(q, `${d} å…¬å°º`, () => `${d + randInt(-7, 9) * 10} å…¬å°º`));
        }
        for(let i=0;i<Math.ceil(n/4);i++){
            const v1 = randInt(30, 70), v2 = randInt(30, 70);
            const t = randInt(6, 18);
            const dist = (v1 + v2) * t;
            const q = `ç”²ä¹™å…©åœ°ç›¸è· ${dist} å…¬å°ºï¼Œç”²ä»¥ ${v1} å…¬å°º/åˆ†ã€ä¹™ä»¥ ${v2} å…¬å°º/åˆ† ç›¸å‘è€Œè¡Œï¼Œå¹¾åˆ†é˜å¾Œç›¸é‡ï¼Ÿ`;
            list.push(buildMCQ(q, `${t} åˆ†é˜`, () => `${t + randInt(-4, 5)} åˆ†é˜`));
        }
        for(let i=0;i<Math.ceil(n/4);i++){
            const belt = randInt(20, 60), walk = randInt(30, 70);
            const sec2 = 12 * randInt(1, 5);
            const same = Math.random() < 0.5;
            const speed = same ? (belt + walk) : Math.abs(walk - belt);
            const d2 = (speed * sec2) / 60;
            const q = `é›»æ‰¶æ¢¯é€Ÿç‡ ${belt} å…¬å°º/åˆ†ï¼Œæª¢ä¿®å“¡èµ°è·¯é€Ÿç‡ ${walk} å…¬å°º/åˆ†ï¼Œ${same ? "åŒæ–¹å‘" : "åæ–¹å‘"}èµ° ${sec2} ç§’ï¼Œå‰é€²å¹¾å…¬å°ºï¼Ÿ`;
            list.push(buildMCQ(q, `${d2} å…¬å°º`, () => `${d2 + randInt(-3, 4)} å…¬å°º`));
        }
        return list.slice(0, n);
    }

    function generateAgeQuestions(n=18){
        const list = [];
        for(let i=0;i<Math.ceil(n/2);i++){
            const k = randInt(3, 6), x = randInt(2, 8), b = randInt(10, 16);
            const a = k*(b - x) + x;
            const q = `ç”²ä»Šå¹´ ${a} æ­²ï¼Œä¹™ä»Šå¹´ ${b} æ­²ã€‚å¹¾å¹´å‰ç”²çš„å¹´é½¡æ˜¯ä¹™çš„ ${k} å€ï¼Ÿ`;
            list.push(buildMCQ(q, `${x} å¹´å‰`, () => `${x + randInt(-3, 4)} å¹´å‰`));
        }
        for(let i=0;i<Math.ceil(n/2);i++){
            const k = randInt(2, 4), x = randInt(2, 10), b = randInt(8, 16);
            const a = k*(b + x) - x;
            const q = `ç”²ä»Šå¹´ ${a} æ­²ï¼Œä¹™ä»Šå¹´ ${b} æ­²ã€‚å¹¾å¹´å¾Œç”²çš„å¹´é½¡æœƒæ˜¯ä¹™çš„ ${k} å€ï¼Ÿ`;
            list.push(buildMCQ(q, `${x} å¹´å¾Œ`, () => `${x + randInt(-4, 5)} å¹´å¾Œ`));
        }
        return list.slice(0, n);
    }

    function generateAvgQuestions(n=18){
        const list = [];
        for(let i=0;i<Math.ceil(n/2);i++){
            const m = randInt(3, 5);
            const avg1 = randInt(80, 92);
            const avg2 = avg1 + randInt(1, 4);
            const sum1 = m * avg1;
            const targetSum = (m+1) * avg2;
            const x = targetSum - sum1;
            const q = `å‰ ${m} æ¬¡å°è€ƒå¹³å‡ ${avg1} åˆ†ï¼Œç¬¬ ${m+1} æ¬¡è¦è€ƒå¹¾åˆ†ï¼Œ${m+1} æ¬¡å¹³å‡æ‰æœƒæ˜¯ ${avg2} åˆ†ï¼Ÿ`;
            list.push(buildMCQ(q, `${x} åˆ†`, () => `${x + randInt(-8, 10)} åˆ†`));
        }
        for(let i=0;i<Math.ceil(n/2);i++){
            const a = randInt(250, 380), b = randInt(250, 380), avg = randInt(280, 360);
            const c = avg * 3 - a - b;
            const q = `é€±ä¸€ ${a} äººã€é€±äºŒ ${b} äººï¼ŒåŠ å…¥é€±ä¸‰å¾Œä¸‰å¤©å¹³å‡ ${avg} äººï¼Œé€±ä¸‰å¹¾äººï¼Ÿ`;
            list.push(buildMCQ(q, `${c} äºº`, () => `${c + randInt(-30, 40)} äºº`));
        }
        return list.slice(0, n);
    }

    let sessionQuestions = { rate: [], age: [], avg: [] };
    function rebuildSessionQuestions(){
        sessionQuestions.rate = baseQuestions.rate.concat(generateRateQuestions(18));
        sessionQuestions.age  = baseQuestions.age.concat(generateAgeQuestions(18));
        sessionQuestions.avg  = baseQuestions.avg.concat(generateAvgQuestions(18));
    }

    function selectMode(name, time) {
        currentModeName = name;
        baseTime = time;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('selected'));
        if(name === 'åŸºç¤') document.getElementById('mode-easy').classList.add('selected');
        if(name === 'é€²éš') document.getElementById('mode-normal').classList.add('selected');
        if(name === 'é­”ç‹') document.getElementById('mode-hard').classList.add('selected');
    }

    function goToMenu() {
        playerName = (document.getElementById('player-name').value || "").trim();
        if(!playerName) { alert("è«‹è¼¸å…¥åå­—ï¼"); return; }
        showScreen('menu-screen');
        document.getElementById('welcome-msg').innerText = "åŠ æ²¹ï¼Œ" + playerName + "ï¼";
        updateLeaderboard();
    }

    function startGame(category, levelName) {
        currentCategory = category;
        currentLevelName = levelName;
        score = 0;
        timeLeft = baseTime;
        combo = 0;

        rebuildSessionQuestions();
        refillRoundDeck();

        showScreen('game-screen');
        clearFeedback();
        updateStats();
        nextQuestion();
        startTimer();
    }

    function startTimer() {
        clearInterval(timerId);
        timerId = setInterval(() => {
            timeLeft--;
            document.getElementById('timer').innerText = timeLeft;
            if(timeLeft <= 0) endGame();
        }, 1000);
    }

    function refillRoundDeck(){
        const pool = sessionQuestions[currentCategory] || [];
        roundDeck = shuffle(pool);
        roundIndex = 0;
    }

    function nextQuestion() {
        const pool = sessionQuestions[currentCategory];
        if(!pool || pool.length === 0) {
            document.getElementById('question-text').innerText = "é¡Œåº«è¼‰å…¥å¤±æ•—ï¼Œè«‹å›é¸å–®å†è©¦ä¸€æ¬¡ã€‚";
            document.getElementById('options').innerHTML = "";
            return;
        }

        if(roundIndex >= roundDeck.length){
            refillRoundDeck();
        }

        currentQuestion = roundDeck[roundIndex++];
        document.getElementById('question-text').innerText = currentQuestion.q;

        const optionsDiv = document.getElementById('options');
        optionsDiv.innerHTML = "";
        currentQuestion.a.forEach((opt, index) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt;
            btn.onclick = () => checkAnswer(index, btn);
            optionsDiv.appendChild(btn);
        });

        // é¡Œç›®å‡ºç¾æ™‚æ¸…æ‰å‰ä¸€æ¬¡å›é¥‹
        clearFeedback();
        lockOptions(false);
    }

    // âœ… å›é¥‹å‘ˆç¾åœ¨ä½œç­”å€ï¼šç­”å°/ç­”éŒ¯é¡¯ç¤ºå¾Œï¼Œè‡ªå‹•é€²ä¸‹ä¸€é¡Œ
    function checkAnswer(selected, btnEl) {
        if(!currentQuestion) return;

        lockOptions(true);
        if(feedbackTimer) clearTimeout(feedbackTimer);

        const correctIndex = currentQuestion.c;
        const correctText = currentQuestion.a[correctIndex];

        // å°æç¤ºï¼šé»åˆ°çš„æŒ‰éˆ•ç¨å¾®æ¨™è¨˜ï¼ˆä¸æ”¹ç‰ˆï¼ŒåªåŠ  inlineï¼‰
        btnEl.style.outline = "3px solid rgba(44,62,80,0.15)";
        btnEl.style.transform = "translateY(-1px)";

        if(selected === correctIndex) {
            combo++;
            score += (10 * combo);
            timeLeft += 5;
            updateStats();

            showFeedback(
                "ok",
                "ç­”å°ï¼",
                `+5 ç§’ï½œCombo x${combo}ï½œç›®å‰å¾—åˆ†ï¼š${score}`
            );
        } else {
            combo = 0;
            timeLeft -= 5;
            if(timeLeft < 0) timeLeft = 0;
            updateStats();

            showFeedback(
                "bad",
                "ç­”éŒ¯ï¼",
                `æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š<strong>${correctText}</strong> ï½œ -5 ç§’ï½œCombo æ­¸é›¶`
            );
        }

        feedbackTimer = setTimeout(() => {
            nextQuestion();
        }, FEEDBACK_MS);
    }

    function updateStats() {
        document.getElementById('score').innerText = score;
        document.getElementById('combo-text').innerText = "Combo x" + combo;
        document.getElementById('timer').innerText = timeLeft;
    }

    function endGame() {
        clearInterval(timerId);
        if(feedbackTimer) clearTimeout(feedbackTimer);
        alert("æ™‚é–“åˆ°ï¼æŒ‘æˆ°çµæŸã€‚\nå¾—åˆ†: " + score);
        saveScore(playerName, score, currentLevelName, currentModeName);
        exitToMenu();
    }

    function saveScore(name, score, level, mode) {
        let scores = JSON.parse(localStorage.getItem('jessieMath_v2_scores') || "[]");
        scores.push({name, score, level, mode, date: new Date().toLocaleDateString()});
        scores.sort((a,b) => b.score - a.score);
        localStorage.setItem('jessieMath_v2_scores', JSON.stringify(scores.slice(0, 10)));
    }

    function updateLeaderboard() {
        let scores = JSON.parse(localStorage.getItem('jessieMath_v2_scores') || "[]");
        const table = document.getElementById('leaderboard');
        if(scores.length === 0) {
            table.innerHTML = "<tr><td colspan='4' style='color:#999;'>æš«ç„¡ç´€éŒ„ï¼Œå¿«ä¾†æŒ‘æˆ°å§ï¼</td></tr>";
            return;
        }
        let html = "<tr><th>æ’å</th><th>å§“å</th><th>é—œå¡/æ¨¡å¼</th><th>åˆ†æ•¸</th></tr>";
        scores.forEach((s, i) => {
            let rank = i===0 ? "ğŸ¥‡" : (i===1 ? "ğŸ¥ˆ" : (i===2 ? "ğŸ¥‰" : i+1));
            html += `<tr><td>${rank}</td><td>${s.name}</td><td>${s.level}<br><small>(${s.mode})</small></td><td>${s.score}</td></tr>`;
        });
        table.innerHTML = html;
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function exitToMenu() {
        clearInterval(timerId);
        if(feedbackTimer) clearTimeout(feedbackTimer);
        showScreen('menu-screen');
        updateLeaderboard();
    }
    function restartLevel() {
        if(feedbackTimer) clearTimeout(feedbackTimer);
        startGame(currentCategory, currentLevelName);
    }
    function pauseGame() { alert("æš«åœä¸­ï¼Œé»æ“Šç¢ºå®šç¹¼çºŒã€‚"); }

    document.addEventListener('keydown', (e) => {
        const onStart = document.getElementById('start-screen').classList.contains('active');
        if(onStart && e.key === 'Enter') goToMenu();
    });
</script>

</body>
</html>
